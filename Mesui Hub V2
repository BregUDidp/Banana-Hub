game.StarterGui:SetCore("SendNotification", {
    Title = "กดตัว T เพื่อ Kamui",
    Text = "________________________________________________________",
    Duration = 10
})

game.StarterGui:SetCore("SendNotification", {
    Title = "[ สร้างโดย ] 💤 - ZelX - 💤",
    Text = "________________________________________________________",
    Duration = 10
})

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")

local player = Players.LocalPlayer

local DIMENSION_ORIGIN = Vector3.new(0, 1000000, 0)
local RETURN_POSITION = nil
local IN_KAMUI = false
local WARP_TIME = 0.1
local WINDUP_TIME = 0.87
local COOLDOWN = 2
local lastWarpTime = 0

local kamuiMusic = Instance.new("Sound")
kamuiMusic.SoundId = "rbxassetid://9039981149"
kamuiMusic.Looped = true
kamuiMusic.Volume = 0.5

local function applyKamuiLighting()
	Lighting.Ambient = Color3.new(0,0,0)
	Lighting.OutdoorAmbient = Color3.new(0,0,0)
	Lighting.FogColor = Color3.new(0,0,0)
	Lighting.FogStart = 20
	Lighting.FogEnd = 180
end

local function restoreNormalLighting()
	Lighting.Ambient = Color3.fromRGB(127,127,127)
	Lighting.OutdoorAmbient = Color3.fromRGB(127,127,127)
	Lighting.FogEnd = 100000
end

local dimensionFolder = Instance.new("Folder")
dimensionFolder.Name = "KamuiDimension"
dimensionFolder.Parent = workspace

local AREA_SIZE, WALL_HEIGHT = 300, 150
local spawnPositions = {}
local centralStructurePosition

local floor = Instance.new("Part")
floor.Size = Vector3.new(AREA_SIZE,1,AREA_SIZE)
floor.Anchored = true
floor.Position = DIMENSION_ORIGIN
floor.Color = Color3.new(0,0,0)
floor.Material = Enum.Material.SmoothPlastic
floor.Parent = dimensionFolder

local wallData = {
	{Vector3.new(AREA_SIZE/2,WALL_HEIGHT/2,0), Vector3.new(1,WALL_HEIGHT,AREA_SIZE)},
	{Vector3.new(-AREA_SIZE/2,WALL_HEIGHT/2,0), Vector3.new(1,WALL_HEIGHT,AREA_SIZE)},
	{Vector3.new(0,WALL_HEIGHT/2,AREA_SIZE/2), Vector3.new(AREA_SIZE,WALL_HEIGHT,1)},
	{Vector3.new(0,WALL_HEIGHT/2,-AREA_SIZE/2), Vector3.new(AREA_SIZE,WALL_HEIGHT,1)}
}

for _, data in ipairs(wallData) do
	local wall = Instance.new("Part")
	wall.Position = DIMENSION_ORIGIN + data[1]
	wall.Size = data[2]
	wall.Anchored = true
	wall.Color = Color3.new(0,0,0)
	wall.Material = Enum.Material.SmoothPlastic
	wall.Parent = dimensionFolder
end

local ceiling = Instance.new("Part")
ceiling.Size = Vector3.new(AREA_SIZE,1,AREA_SIZE)
ceiling.Position = DIMENSION_ORIGIN + Vector3.new(0,WALL_HEIGHT,0)
ceiling.Anchored = true
ceiling.Color = Color3.new(0,0,0)
ceiling.Material = Enum.Material.SmoothPlastic
ceiling.Parent = dimensionFolder

local function createStructures()
	spawnPositions = {}
	local structureCount = 130
	local seed = 12345

	local function deterministicRandom(a, b)
		seed = (seed * 9301 + 49297) % 233280
		local rnd = seed / 233280
		return a + rnd * (b - a)
	end

	for i = 1, structureCount do
		local block = Instance.new("Part")
		block.Anchored = true
		block.Material = Enum.Material.SmoothPlastic
		block.Color = Color3.new(1,1,1)

		local sizeX = deterministicRandom(10, 20)
		local sizeY = deterministicRandom(18, 30)
		local sizeZ = deterministicRandom(10, 20)
		if i == 1 then sizeX, sizeY, sizeZ = 30, 25, 30 end
		block.Size = Vector3.new(sizeX, sizeY, sizeZ)

		local offsetX, offsetZ
		if i == 1 then
			offsetX, offsetZ = 0, 0
		else
			offsetX = deterministicRandom(-AREA_SIZE/2 + 8, AREA_SIZE/2 - 8)
			offsetZ = deterministicRandom(-AREA_SIZE/2 + 8, AREA_SIZE/2 - 8)
		end
		local baseY = sizeY / 2
		block.Position = DIMENSION_ORIGIN + Vector3.new(offsetX, baseY, offsetZ)
		block.Parent = dimensionFolder

		local glow = Instance.new("PointLight")
		glow.Brightness = 2
		glow.Range = 18
		glow.Color = Color3.new(1,1,1)
		glow.Parent = block

		local spawnPos = block.Position + Vector3.new(0, sizeY/2 + 3, 0)
		table.insert(spawnPositions, spawnPos)
		if i == 1 then centralStructurePosition = spawnPos end
	end
end
createStructures()

local function warpEffect(callback)
	local blur = Instance.new("BlurEffect")
	blur.Size = 0
	blur.Parent = Lighting

	local tweenIn = TweenService:Create(blur,TweenInfo.new(WARP_TIME,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{Size=24})
	tweenIn:Play()
	tweenIn.Completed:Wait()

	callback()

	local tweenOut = TweenService:Create(blur,TweenInfo.new(WARP_TIME,Enum.EasingStyle.Sine,Enum.EasingDirection.In),{Size=0})
	tweenOut:Play()
	tweenOut.Completed:Wait()

	blur:Destroy()
end

local function playWindup(char, humanoid, hrp, callback)
	local originalWalkSpeed = humanoid.WalkSpeed
	humanoid.WalkSpeed = 0
	hrp.Anchored = true

	local windupAnim = Instance.new("Animation")
	windupAnim.AnimationId = "rbxassetid://32729592"
	local animTrack = humanoid:LoadAnimation(windupAnim)
	animTrack:Play()

	local partsToFade = {}
	for _, obj in ipairs(char:GetDescendants()) do
		if obj:IsA("BasePart") and obj ~= hrp then
			table.insert(partsToFade, obj)
		elseif obj:IsA("Accessory") then
			local handle = obj:FindFirstChild("Handle")
			if handle then table.insert(partsToFade, handle) end
		elseif obj:IsA("Decal") or obj:IsA("Texture") then
			table.insert(partsToFade, obj)
		end
	end

	for _, part in ipairs(partsToFade) do
		if part:IsA("BasePart") then
			TweenService:Create(part, TweenInfo.new(WINDUP_TIME), {Transparency=1}):Play()
		elseif part:IsA("Decal") or part:IsA("Texture") then
			TweenService:Create(part, TweenInfo.new(WINDUP_TIME), {Transparency=1}):Play()
		end
	end

	task.wait(WINDUP_TIME)

	for _, part in ipairs(partsToFade) do
		if part:IsA("BasePart") then
			part.Transparency = 0
		elseif part:IsA("Decal") or part:IsA("Texture") then
			part.Transparency = 0
		end
	end

	animTrack:Stop()
	humanoid.WalkSpeed = originalWalkSpeed
	hrp.Anchored = false

	callback()
end

local screenGui = Instance.new("ScreenGui")
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.DisplayOrder = 100
screenGui.Parent = player:WaitForChild("PlayerGui")

local bg = Instance.new("ImageLabel")
bg.Parent = screenGui
bg.BackgroundTransparency = 1
bg.Size = UDim2.new(0,700,0,700)
bg.Position = UDim2.new(0.5,0,0.5,0)
bg.AnchorPoint = Vector2.new(0.5,0.5)
bg.Image = "rbxassetid://135542686675252"
bg.ImageTransparency = 1

local flash = Instance.new("Frame")
flash.Size = UDim2.new(1,0,1,0)
flash.Position = UDim2.new(0,0,0,0)
flash.BackgroundColor3 = Color3.new(0,0,0)
flash.BackgroundTransparency = 1
flash.BorderSizePixel = 0
flash.ZIndex = 2
flash.Parent = screenGui

local sound = Instance.new("Sound")
sound.SoundId = "rbxassetid://132492029022208"
sound.Volume = 1
sound.Parent = screenGui

local tweenInfo = TweenInfo.new(0.7,Enum.EasingStyle.Quad,Enum.EasingDirection.Out)
local function kamuisharingan()
	flash.BackgroundTransparency = 0.5
	bg.ImageTransparency = 0
	TweenService:Create(flash,tweenInfo,{BackgroundTransparency=1}):Play()
	TweenService:Create(bg,tweenInfo,{ImageTransparency=1}):Play()
	sound:Play()
end

local function goToKamui(char, humanoid, hrp)
	if _G.InPose then return end  
	RETURN_POSITION = hrp.CFrame
	playWindup(char, humanoid, hrp, function()
		warpEffect(function()
			applyKamuiLighting()
			hrp.CFrame = CFrame.new(centralStructurePosition)
			kamuiMusic:Play()
			kamuisharingan()
		end)
		IN_KAMUI = true
	end)
end

local function leaveKamui(char, humanoid, hrp)
	if _G.InPose then return end  
	playWindup(char, humanoid, hrp, function()
		warpEffect(function()
			restoreNormalLighting()
			if RETURN_POSITION then hrp.CFrame = RETURN_POSITION end
			kamuiMusic:Stop()
			kamuisharingan()
		end)
		IN_KAMUI = false
	end)
end

local function setupCharacter(char)
	local hrp = char:WaitForChild("HumanoidRootPart")
	local humanoid = char:WaitForChild("Humanoid")

	hrp.Transparency = 1
	hrp.CanCollide = false
	kamuiMusic.Parent = hrp

	UserInputService.InputBegan:Connect(function(input, processed)
		if processed then return end
		if input.KeyCode == Enum.KeyCode.T then
			if tick() - lastWarpTime >= COOLDOWN then
				lastWarpTime = tick()
				if IN_KAMUI then
					leaveKamui(char, humanoid, hrp)
				else
					goToKamui(char, humanoid, hrp)
				end
			end
		end
	end)
end

if player.Character then
	setupCharacter(player.Character)
end

player.CharacterAdded:Connect(setupCharacter)

UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == key then
		toggle()
	end
end)
